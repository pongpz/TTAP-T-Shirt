<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns="http://www.w3.org/1999/html">
<head>
    <meta charset="UTF-8"/>
    <title>TTAP T-SHIRT</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:300,400,700" />
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css" />
    <link rel="shortcut icon" type="image/png"
          th:href="@{/images/logo2tap.jpg}" />
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@200;300;400;600;900&display=swap" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" integrity="sha512-..." crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link th:href="@{/customercss/bootstrap.min.css}" rel="stylesheet" type="text/css" />
    <link th:href="@{/customercss/elegant-icons.css}" rel="stylesheet" type="text/css" />
    <link th:href="@{/customercss/nice-select.css}" rel="stylesheet" type="text/css" />
    <link th:href="@{/customercss/jquery-ui.min.css}" rel="stylesheet" type="text/css" />
    <link th:href="@{/customercss/owl.carousel.min.css}" rel="stylesheet" type="text/css" />
    <link th:href="@{/customercss/slicknav.min.css}" rel="stylesheet" type="text/css" />
    <link th:href="@{/customercss/style.css}" rel="stylesheet" type="text/css" />
    <link th:href="@{/customercss/style-customer.css}" rel="stylesheet" type="text/css" />
    <link th:href="@{/customercss/cart-hover.css}" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" href="/customcss/toastMessage.css ">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.css" rel="stylesheet"
          type="text/css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <style>
        h1, h3 {
            margin-bottom: 20px;
        }

        table {
            background-color: #fff;
            border-radius: 5px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        table th, table td {
            text-align: center;
        }

        .btn-primary {
            background-color: #007bff;
            border-color: #007bff;
        }

        footer {
            background-color: #343a40;
            color: #fff;
            padding: 20px 0;
        }
        .card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            cursor: pointer;
        }

        .card:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .card-body {
            background: linear-gradient(135deg, #e0f7fa, #e8eaf6);
            padding: 1.2rem;
        }

        .card-title {
            font-size: 1rem;
            font-weight: bold;
        }

        .card:hover .card-title {
            color: #ff5722;
        }

        .form-check-input:checked + .card {
            border-color: #ff5722;
            background: #ffe0b2;
        }

    </style>
</head>
<body>
<header th:replace="~{/fragment/header-customer :: header-customer}"></header>
<div id="toast-root"></div>
<section>
    <div class="cart-content-2021">
        <div class="cart-content-2021-left">
            <div class="container my-4">
                <form th:action="@{/TTAP/cart/checkout}" method="post" onsubmit="return validateCartSelection()">

                    <div class="card mb-4">
                        <div class="card-header d-flex align-items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                                 class="bi bi-geo-alt me-2" viewBox="0 0 16 16">
                                <path d="M12.166 8.94c0 1.126-2.614 4.385-3.675 5.69a.866.866 0 0 1-1.312 0C6.112 13.325 3.5 10.066 3.5 8.94 3.5 6.614 5.22 5 8 5s4.5 1.614 4.5 3.94zm-.966-.94c0-1.29-1.267-2.4-3.2-2.4s-3.2 1.11-3.2 2.4c0 .844.9 2.32 3.2 4.792 2.3-2.472 3.2-3.948 3.2-4.792z"/>
                                <path d="M8 8.5a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3z"/>
                            </svg>
                            <h5 class="mb-0">Địa chỉ nhận hàng</h5>
                        </div>
                        <div class="card-body">
                            <div class="row align-items-center">
                                <div class="col-md-10">

                                    <div th:if="${selectedAddress == null }">
                                        <p>Chưa có địa chỉ nào. Hãy thêm địa chỉ mới.</p>
                                    </div>
                                    <div th:if="${selectedAddress != null}">
                                        <p class="fw-bold mb-1" th:text="${selectedAddress.hoTen}"></p>
                                        <input type="hidden" name="nguoiNhan" th:value="${selectedAddress.hoTen}">
                                        <p class="fw-bold mb-1" th:text="${selectedAddress.soDienThoai}"></p>
                                        <input type="hidden" name="soDienThoai" th:value="${selectedAddress.soDienThoai}">
                                        <p class="mb-1" th:text="${selectedAddress.soNha} + ' - ' + ${selectedAddress.tenDuong}
                                + ' - ' + ${selectedAddress.tenQuanhuyen} + ' - ' + ${selectedAddress.tenThanhpho}"></p>
                                        <input type="hidden" name="diaChi" th:value="${selectedAddress.soNha} + ' - '
                                + ${selectedAddress.tenDuong} + ' - ' + ${selectedAddress.tenQuanhuyen} + ' - ' + ${selectedAddress.tenThanhpho}">
                                    </div>


                                </div>
                                <div class="col-md-2 text-end">
                                    <button type="button" class="btn btn-outline-primary btn-sm" data-bs-toggle="modal"
                                            data-bs-target="#selectAddressModal">Thay đổi
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <!-- Cart Items Section -->
                        <div class="col-md-9">
                            <div class="d-flex border-bottom pb-4">
                                <div class="col-md-4 d-flex align-items-center">
                                    <input type="checkbox" class="form-check-input me-2" id="selectAll"
                                           onchange="toggleSelectAll(this)">
                                    <span>Tất cả (sản phẩm)</span>
                                </div>
                                <div class="col-md-2 text-center fw-bold">Đơn giá</div>
                                <div class="col-md-2 text-center fw-bold">Số lượng</div>
                                <div class="col-md-2 text-center fw-bold">Thành tiền</div>

                            </div>

                            <div class="mt-3">
                                <!-- Single Item Row -->
                                <div class="row align-items-center border-bottom py-2 js-item-row"
                                     th:each="item, iterStat : ${cart.items}">
                                    <!-- Checkbox và Hình ảnh sản phẩm -->
                                    <div class="col-6 col-md-4 d-flex align-items-center px-1">
                                        <input type="checkbox"
                                               name="selectedProductIds" th:value="${item.chiTietSanPham.id}"
                                               class="product-checkbox" onchange="calculateTotal()">
                                        <img th:src="${productImages[item.chiTietSanPham.sanPham.id]}"
                                             alt="Product Image"
                                             class="img-thumbnail me-3"
                                             style="width: 80px; height: 80px; object-fit: contain;">
                                        <div>
                                            <a th:href="@{/TTAP/san-pham-detail/{id}(id=${item.chiTietSanPham.sanPham.id})}" class="text-dark fw-bold"
                                               th:text="${item.chiTietSanPham.sanPham.ten}"></a>
                                            <p class="small text-muted mb-1">Mã SP: <b
                                                    th:text="${item.chiTietSanPham.ma}"></b></p>
                                            <p class="small text-success"> Màu sắc: <b
                                                    th:text="${item.chiTietSanPham.mauSac.ten}"></b></p>
                                            <p class="small text-success"> Kích cỡ: <b
                                                    th:text="${item.chiTietSanPham.kichCo.ten}"></b></p>
                                            <p class="small text-black">
                                                Số lượng trong kho: <b th:text="${productStockQuantities[item.chiTietSanPham.id]}"></b>
                                            </p>
                                        </div>
                                    </div>

                                    <!-- Giá sản phẩm -->
                                    <div class="col-4 col-md-2 text-center px-1">
                                      <span class="fw-normal product-price"
                                            th:id="'originPrice_' + ${item.id}"
                                            th:text="${numberUtils.formatCurrency(item.gia)}"
                                            th:attr="data-price=${item.gia}"></span>
                                    </div>

                                    <!-- Số lượng sản phẩm -->
                                    <div class="col-4 col-md-2 text-center px-1">
                                        <div class="d-flex align-items-center justify-content-center">
                                            <button type="button" class="btn btn-sm btn-outline-secondary btn-quantity"
                                                    th:data-id="${item.id}" onclick="updateQuantity(this, 'minus')"
                                                    >-
                                            </button>
                                            <input class="form-control form-control-sm text-center mx-2 quantity-input"
                                                   style="width: 50px;"
                                                   type="number" name="quantity" readonly
                                                   th:id="'quantityInput_' + ${item.id}"
                                                   th:value="${item.soLuong}"
                                                   th:attr="data-id=${item.id},data-max-quantity=${item.chiTietSanPham.soLuong}" min="1"
                                                   oninput="validateQuantity(this)"
                                            >
                                            <button type="button" class="btn btn-sm btn-outline-secondary btn-quantity"
                                                    th:data-id="${item.id}" onclick="updateQuantity(this, 'plus')"
                                                    >+
                                            </button>
                                        </div>
                                    </div>

                                    <!-- Thành tiền -->
                                    <div class="col-4 col-md-2 text-center px-1">
                                 <span class="fw-bold text-danger product-amount"
                                       th:id="'totalPrice_' + ${item.id}"
                                       th:attr="data-total=${item.gia * item.soLuong}"
                                       th:text="${numberUtils.formatCurrency(item.gia * item.soLuong)}"></span>
                                    </div>

                                    <!-- Nút xóa sản phẩm -->
                                    <div class="col-4 col-md-2 text-center px-1">
                                        <a th:href="@{/TTAP/cart/remove(productId=${item.id})}"
                                           class="btn btn-danger btn-sm" onclick="return confirm('Bạn có chắc chắn muốn xóa sản phẩm này này?');">
                                            <i class="bi bi-trash"></i> Xóa
                                        </a>
                                    </div>
                                </div>
                                <!-- End Single Item Row -->
                            </div>
                        </div>
                        <!-- Cart Summary Section -->
                        <div class="col-md-3">
                            <div class="p-3 border rounded">
                                <div class="mb-3">
                                    <label for="discount_code" class="form-label">Mã giảm giá</label>
                                    <div class="input-group">
                                        <input type="text" id="discount_code" class="form-control" placeholder="Chưa chọn mã giảm giá" disabled>
                                    </div>
                                    <button type="button" class="btn btn-info mt-3" data-bs-toggle="modal" data-bs-target="#discountModal">
                                        Chọn Mã Giảm Giá
                                    </button>
                                    <small id="js-voucher-message" class="text-danger"></small>
                                </div>
                                <div class="border-top pt-3">
                                    <p class="d-flex justify-content-between mb-2">
                                        <span>Tạm tính</span>
                                        <span class="total-cart-price" id="totalAmount">0₫</span>
                                    </p>
                                    <p class="d-flex justify-content-between mb-2">
                                        <span>Giảm giá</span>
                                        <span id="price-discount">0₫</span>
                                        <input type="hidden" name="idGiamgia" id="idGiamgia">
                                    </p>
                                    <p class="d-flex justify-content-between mb-2">
                                        <span>Phí vận chuyển</span>
                                        <span class="shipping-fee" id="shippingFee">0₫</span>
                                    </p>
                                    <p class="d-flex justify-content-between fw-bold mb-2">
                                        <span>Thành tiền</span>
                                        <span class="text-danger total-cart-payment"
                                              id="total-cart-payment">0₫</span>
                                    </p>
                                    <small class="text-muted">(Đã bao gồm VAT nếu có)</small>
                                </div>
                                <button class="btn btn-success w-100 mt-3" type="submit" onclick="submitCheckout()">Tiến hành đặt hàng</button>
                            </div>
                        </div>
                    </div>

                </form>
                <!-- Địa chỉ nhận hàng -->
            </div>
        </div>
    </div>
    <div class="alert alert-danger text-center" role="alert" th:if="${cart.items == null or cart.items.isEmpty()}">
        <p>Giỏ hàng của bạn đang trống.</p>
    </div>
    <!-- Modal Chọn Mã Giảm Giá -->
    <div class="modal fade" id="discountModal" tabindex="-1" aria-labelledby="discountModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="discountModalLabel">Chọn Mã Giảm Giá</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Thông báo nếu chưa chọn sản phẩm -->
                    <div id="noProductSelectedWarning" class="alert alert-warning" style="display: none;">
                        <strong>Thông báo:</strong> Bạn cần chọn ít nhất một sản phẩm trước khi áp dụng mã giảm giá.
                    </div>

                    <form id="discountForm">
                        <div class="row">
                            <!-- Lặp qua danh sách mã giảm giá -->
                            <div class="col-md-6 mb-4" th:each="voucher : ${danhSachMaGiamGia}" >
                                <div class="card border-info shadow-sm" style="border-radius: 12px;">
                                    <div class="card-body">
                                        <div class="d-flex align-items-center">
                                            <!-- Radio input -->
                                            <input class="form-check-input me-3" type="radio" name="discount"
                                                   th:id="'voucher-' + ${voucher.maGiamGia.id}" th:value="${voucher.maGiamGia.id}" style="transform: scale(1.3);">
                                            <!-- Nội dung mã giảm giá -->
                                            <div>
                                                <h6 class="card-title fw-bold mb-1 text-primary" th:text="${voucher.maGiamGia.ten}"></h6>
                                                <p class="mb-1 text-muted" style="font-size: 0.9rem;">
                                                    Giảm <span th:text="${voucher.maGiamGia.giaTriGiam + '%'}" class="text-danger"></span>, tối đa
                                                    <span th:text="${numberUtils.formatCurrency(voucher.maGiamGia.giaTriToiDa)}"></span>
                                                </p>
                                                <p class="mb-1 text-muted" style="font-size: 0.9rem;">
                                                    <strong>Đơn tối thiểu:</strong>
                                                    <span th:text="${numberUtils.formatCurrency(voucher.maGiamGia.giaTriToiThieu)}"></span>
                                                </p>
                                                <p class="mb-0 text-muted" style="font-size: 0.9rem;">
                                                    <strong>Hiệu lực:</strong>
                                                    <span th:text="${voucher.maGiamGia.thoiGianHieuLuc}"></span>
                                                </p>
                                                <p class="mb-0 text-muted" style="font-size: 0.9rem;">
                                                    <span class="badge bg-danger rounded-pill px-2 py-1" th:text="${voucher.soLuong}"></span>
                                                </p>

                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                    <button type="button" class="btn btn-warning text-white" id="applyDiscountBtn" onclick="applyDiscount()">
                        Áp dụng mã giảm giá
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="selectAddressModal" tabindex="-1" aria-labelledby="selectAddressModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <!-- Tiêu đề -->
                <div class="modal-header">
                    <h5 class="modal-title" id="selectAddressModalLabel">Chọn Địa Chỉ Giao Hàng</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <!-- Nội dung -->
                <div class="modal-body">
                    <!-- Kiểm tra danh sách địa chỉ -->
                    <div th:if="${addresses != null && !addresses.isEmpty()}">
                        <form id="addressForm" th:action="@{/TTAP/cart/updateAddress}" method="post">
                            <div class="list-group">
                                <!-- Lặp qua danh sách địa chỉ -->
                                <div th:each="address, iterStat : ${addresses}" class="list-group-item d-flex justify-content-between align-items-center">
                                    <div class="d-flex align-items-center">
                                        <input class="form-check-input me-3" type="radio" name="addressId"
                                               th:id="'address' + ${iterStat.index}" th:value="${address.id}"
                                               th:checked="${selectedAddress != null and selectedAddress.id == address.id}">
                                        <label class="form-check-label w-100" th:for="'address' + ${iterStat.index}">
                                            <p class="fw-bold mb-1" th:text="${address.hoTen}"></p>
                                            <p class="fw-bold mb-1" th:text="${address.soDienThoai}"></p>
                                            <span  th:text="${address.soNha} + ', ' + ${address.tenDuong} + ', ' + ${address.tenQuanhuyen} + ', ' + ${address.tenThanhpho}" ></span>
                                        </label>
                                    </div>
                                    <!-- Icon xóa địa chỉ -->
                                    <a th:href="@{/TTAP/cart/deleteAddress/{id}(id=${address.id})}" class="text-danger ms-3" onclick="return confirm('Bạn có chắc chắn muốn xóa địa chỉ này?')" title="Xóa địa chỉ">
                                        <i class="fas fa-trash-alt"></i>
                                    </a>
<!--                                    <a th:href="@{/TTAP/user/address/update/{id}(id=${address.id})}" class="text-primary ms-3"-->
<!--                                       title="Chi tiết địa chỉ">-->
<!--                                        <i class="fas fa-info-circle"></i>-->
<!--                                    </a>-->

                                </div>
                            </div>
                            <!-- Nút chọn địa chỉ -->
                            <div class="d-flex justify-content-end mt-4">
                                <button type="submit" class="btn btn-primary">Chọn Địa Chỉ</button>
                            </div>
                        </form>
                    </div>
                    <!-- Thông báo nếu không có địa chỉ -->
                    <div th:if="${addresses == null || addresses.isEmpty()}">
                        <div class="alert alert-warning text-center">
                            <p>Chưa có địa chỉ nào. Hãy thêm địa chỉ mới.</p>
                        </div>
                    </div>
                    <!-- Nút thêm địa chỉ mới -->
                    <div class="d-flex justify-content-center mt-3">
                        <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#createAddressModal">
                            Thêm Địa Chỉ Mới
                        </button>
                    </div>
                </div>
                <!-- Footer -->
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Huỷ</button>
                </div>
            </div>
        </div>
    </div>


    <div class="modal fade" id="createAddressModal" tabindex="-1" aria-labelledby="createAddressModalLabel"
         aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="createAddressModalLabel">Tạo Địa Chỉ</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Form nhập địa chỉ -->
                    <form th:action="@{/TTAP/user/address}" method="post" th:object="${address}" onsubmit="return validateAddressForm()">
                        <div class="mb-3">
                            <label for="fullName" class="form-label">Họ và tên</label>
                            <input type="text" class="form-control" id="fullName" placeholder="Họ và tên" th:field="*{hoTen}" maxlength="64" autocomplete="name">
                        </div>
                        <div class="mb-3">
                            <label for="phoneNumber" class="form-label">Số điện thoại</label>
                            <input type="text" class="form-control" id="phoneNumber" placeholder="Số điện thoại" th:field="*{soDienThoai}" autocomplete="user-address-phone" >
                        </div>
                        <div class="mb-3">
                            <label for="soNha" class="form-label">Số nhà</label>
                            <input type="text" class="form-control" id="soNha" th:field="*{soNha}" required>
                        </div>
                        <div class="mb-3">
                            <label>Tỉnh/Thành phố</label>
                            <select class="form-select" id="tinh" name="tenThanhpho" title="Chọn Tỉnh Thành" th:field="*{tenThanhpho}">
                                <option value="0">Tỉnh Thành</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="quan" class="form-label">Quận/Huyện</label>
                            <select class="form-select" id="quan" name="tenQuanhuyen" title="Chọn Quận Huyện" th:field="*{tenQuanhuyen}">
                                <option value="0">Quận Huyện</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="phuong" class="form-label">Phường/Xã</label>
                            <select class="form-select" id="phuong" name="tenDuong" title="Chọn Phường Xã" th:field="*{tenDuong}">
                                <option value="0">Phường Xã</option>
                            </select>
                        </div>

                        <button type="submit" class="btn btn-primary">Tạo Địa Chỉ</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</section>
<script>
    // Kiểm tra sản phẩm được chọn và thông báo nếu chưa có sản phẩm
    function checkSelectedProducts() {
        const productCheckboxes = document.querySelectorAll('input[name="selectedProductIds"]:checked');
        const applyDiscountBtn = document.getElementById('applyDiscountBtn');
        const noProductWarning = document.getElementById('noProductSelectedWarning');

        // Nếu không có sản phẩm được chọn, hiển thị cảnh báo và vô hiệu hóa nút
        if (productCheckboxes.length === 0) {
            applyDiscountBtn.disabled = true;
            noProductWarning.style.display = 'block';  // Hiển thị thông báo
        } else {
            applyDiscountBtn.disabled = false;
            noProductWarning.style.display = 'none';  // Ẩn thông báo
        }
    }

    // Gọi hàm kiểm tra khi modal được mở
    document.getElementById('discountModal').addEventListener('show.bs.modal', checkSelectedProducts);

    // Lắng nghe sự kiện thay đổi trên các checkbox sản phẩm
    document.querySelectorAll('input[name="selectedProductIds"]').forEach(checkbox => {
        checkbox.addEventListener('change', checkSelectedProducts);
    });
</script>
<script>
    function validateAddressForm() {
        const fields = [ 'fullName','phoneNumber','soNha', 'tenDuong', 'tenQuanhuyen', 'tenThanhpho'];
        let isValid = true;

        fields.forEach(field => {
            const input = document.getElementById(field);
            const value = input.value.trim(); // Loại bỏ khoảng trắng dư thừa

            // Kiểm tra xem trường có để trống không
            if (!value) {
                isValid = false;
                input.classList.add('is-invalid'); // Thêm lớp hiển thị lỗi
                input.nextElementSibling.textContent = 'Trường này không được để trống.';
            } else {
                input.classList.remove('is-invalid'); // Loại bỏ lớp lỗi nếu hợp lệ
                input.nextElementSibling.textContent = '';
            }
        });

        return isValid; // Ngăn submit nếu không hợp lệ
    }

    function validateCartSelection() {
        // Lấy danh sách các checkbox sản phẩm
        const checkboxes = document.querySelectorAll('.product-checkbox');
        let isProductSelected = false;

        // Kiểm tra xem có sản phẩm nào được chọn không
        checkboxes.forEach(checkbox => {
            if (checkbox.checked) {
                isProductSelected = true;
            }
        });

        // Nếu không có sản phẩm nào được chọn, hiển thị thông báo lỗi
        if (!isProductSelected) {
            alert("Vui lòng chọn ít nhất một sản phẩm để tiến hành đặt hàng.");
            return false; // Ngăn chặn việc gửi form
        }

        const selectedAddress = document.querySelector('input[name="diaChi"]');
        if (!selectedAddress || selectedAddress.value.trim() === "") {
            alert("Vui lòng chọn hoặc nhập địa chỉ giao hàng.");
            return false; // Ngăn chặn việc gửi form
        }

        return confirm('Bạn có chắc chắn muốn đặt hàng không?'); // Cho phép gửi form
    }
</script>
<script>
    // Khi modal "createAddressModal" đóng lại
    const createAddressModal = document.getElementById('createAddressModal');
    const selectAddressModal = new bootstrap.Modal(document.getElementById('selectAddressModal'));

    createAddressModal.addEventListener('hidden.bs.modal', function () {
        // Tự động mở lại modal "selectAddressModal"
        selectAddressModal.show();
    });
</script>
<script>
    function applyDiscount() {
        // Kiểm tra xem có sản phẩm nào được chọn không
        const checkboxes = document.querySelectorAll('.product-checkbox:checked');
        if (checkboxes.length === 0) {
            alert('Vui lòng chọn ít nhất một sản phẩm!');
            return; // Nếu không có sản phẩm nào được chọn, không làm gì cả
        }

        // Kiểm tra xem mã giảm giá nào đã được chọn
        const selectedVoucherId = document.querySelector('input[name="discount"]:checked')?.value;
        if (!selectedVoucherId) {
            alert('Vui lòng chọn một mã giảm giá!');
            return; // Nếu không có mã giảm giá nào được chọn, không làm gì cả
        }

        // Gán giá trị selectedVoucherId vào trường hidden idGiamgia
        document.getElementById('idGiamgia').value = selectedVoucherId;

        // Lấy tổng tiền trước khi áp dụng giảm giá
        const totalMoneyBefore = parseFloat(document.getElementById('totalAmount').innerText.replace('₫', '').trim()) || 0;
        console.log("Tổng tiền tạm tính:", totalMoneyBefore);

        // Gửi yêu cầu AJAX để áp dụng mã giảm giá
        fetch(`/TTAP/cart/apply-discount?discount_code=${selectedVoucherId}`, {
            method: 'POST',
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Không thể áp dụng mã giảm giá. Vui lòng thử lại sau.');
                }
                return response.json();
            })
            .then(data => {
                console.log("Dữ liệu từ API:", data);

                // Kiểm tra điều kiện áp dụng mã giảm giá (đơn tối thiểu)
                const minOrderValue = formatCurrency(data.condition);
                console.log("don min;",minOrderValue)// Đơn tối thiểu từ API
                if (totalMoneyBefore < minOrderValue) {
                    const additionalAmount = minOrderValue - totalMoneyBefore;
                    throw new Error(`Không thể áp dụng mã giảm giá. Cần mua thêm ${formatCurrencyVc(additionalAmount)} để áp dụng mã.`);
                }

                // Nếu có giá trị giảm giá, áp dụng vào giao diện
                if (data.discountAmount !== undefined) {
                    const discount = (data.discountAmount / 100.0) * totalMoneyBefore;
                    console.log("Giảm giá:", discount);

                    // Cập nhật giảm giá vào giao diện
                    document.getElementById('price-discount').innerText = formatCurrencyVc(discount);
                    document.getElementById('discount_code').innerText = data.discountCode;

                    // Lấy phí vận chuyển
                    const shippingFee = parseFloat(document.getElementById('shippingFee').innerText.replace('₫', '').trim()) || 0;
                    console.log("Phí vận chuyển:", shippingFee);

                    // Tính tổng tiền sau khi áp dụng giảm giá và phí vận chuyển
                    const finalAmount = totalMoneyBefore - discount + shippingFee;
                    document.getElementById('total-cart-payment').innerText = formatCurrencyVc(finalAmount);

                    alert('Áp dụng mã giảm giá thành công!');
                } else {
                    alert('Mã giảm giá không hợp lệ hoặc không có thông tin giảm giá.');
                }
            })
            .catch(error => {
                console.error('Lỗi khi áp dụng mã giảm giá:', error);
                alert(error.message); // Hiển thị thông báo lỗi cho người dùng
            });
    }
    // Hàm xử lý khi chọn địa chỉ
    function handleAddressSelection() {
        const selectedAddressId = $('input[name="addressId"]:checked').val();
        if (selectedAddressId) {
            // Gọi API lấy thông tin địa chỉ
            $.ajax({
                url: `/shipping/api/address/${selectedAddressId}`, // Gửi ID chọn vào API
                method: 'GET',
                success: function(address) {
                    console.log("Địa chỉ nhận được từ API:", address);
                    if (address && address.id) {
                        // Gọi API tính phí ship
                        calculateShippingFee(address);
                    } else {
                        toastError('Lỗi', 'Dữ liệu địa chỉ không hợp lệ');
                    }
                },
                error: function() {
                    toastError('Lỗi', 'Không thể lấy thông tin địa chỉ');
                }
            });
        } else {
            toastError('Lỗi', 'Không có địa chỉ nào được chọn');
        }
    }

    // Hàm tính phí ship
    function calculateShippingFee(address) {
        $.ajax({
            url: '/shipping/api/shipping/calculate',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(address), // Gửi địa chỉ vào API tính phí ship
            success: function(response) {
                console.log("Phản hồi tính phí ship:", response);
                if (response.status === 'success') {
                    // Cập nhật UI với phí ship mới
                    const shippingFee = response.shippingFee;
                    $('#shippingFee').text(formatCurrency(shippingFee));

                    // Tính lại tổng tiền
                    const currentTotal = parseFloat($('#totalAmount').attr('data-amount') || 0);
                    const finalAmount = currentTotal + shippingFee;
                    $('#total-cart-payment').text(formatCurrency(finalAmount));
                } else {
                    toastError('Lỗi', response.message || 'Không thể tính phí ship');
                }
            },
            error: function() {
                toastError('Lỗi', 'Không thể tính phí ship');
            }
        });
    }

    // Thêm event listener cho radio button địa chỉ
    $('input[name="addressId"]').change(handleAddressSelection);

    // Sửa lại hàm calculateTotal
    function calculateTotal() {
        const checkboxes = $('.product-checkbox:checked');
        let total = 0;

        checkboxes.each(function() {
            const productRow = $(this).closest('.js-item-row');
            const priceElement = productRow.find('.product-amount');
            const price = parseFloat(priceElement.attr('data-total') || 0);
            total += price;
        });

        // Cập nhật tổng tiền sản phẩm
        $('#totalAmount')
            .text(formatCurrency(total))
            .attr('data-amount', total);

        // Tính lại phí ship nếu có địa chỉ được chọn
        if (checkboxes.length > 0) {
            const selectedAddressId = $('input[name="addressId"]:checked').val();
            if (selectedAddressId) {
                handleAddressSelection();
            }
        } else {
            // Reset shipping fee và total payment
            $('#shippingFee').text(formatCurrency(0));
            $('#total-cart-payment').text(formatCurrency(total));
        }
        // Gọi lại hàm áp dụng mã giảm giá nếu có
        applyDiscount();
    }

    function validateQuantity(input) {
        const currentQuantity = parseInt(input.value, 10);
        const maxQuantity = parseInt(input.getAttribute('data-max-quantity'), 10);

        if (currentQuantity > maxQuantity) {
            alert(`Số lượng không thể vượt quá ${maxQuantity}`);
            input.value = maxQuantity;
        } else if (currentQuantity < 1) {
            alert("Số lượng không thể nhỏ hơn 1");
            input.value = 1;
        }

        // Gọi hàm tính lại tổng tiền nếu cần
        calculateTotal();
    }

    function toggleSelectAll(selectAllCheckbox) {
        var checkboxes = document.querySelectorAll('.product-checkbox');
        checkboxes.forEach(function (checkbox) {
            checkbox.checked = selectAllCheckbox.checked;
        });
        calculateTotal(); // Cập nhật tổng tiền mỗi khi thay đổi trạng thái của "Select All"
    }

    // Lắng nghe sự kiện thay đổi checkbox
    document.querySelectorAll('.product-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', calculateTotal);
    });

    function updateQuantity(button, action) {
        // Lấy ID sản phẩm và giá trị hiện tại của số lượng
        const productId = $(button).data('id');
        const quantityInput = $('#quantityInput_' + productId);
        let currentQuantity = parseInt(quantityInput.val());
        // Lấy số lượng tồn từ input
        const maxQuantity = parseInt(quantityInput.data('max-quantity') || 0);

        // Cập nhật số lượng sản phẩm
        if (action === 'minus' && currentQuantity > 1) {
            currentQuantity--;
        } else if (action === 'plus' && currentQuantity < maxQuantity) {
            currentQuantity++;
        } else if (action === 'plus' && currentQuantity >= maxQuantity) {
            alert(`Số lượng không thể vượt quá ${maxQuantity}`);
            return;
        }

        // Cập nhật lại giá trị số lượng trong input
        quantityInput.val(currentQuantity);

        // Lấy giá trị đơn giá từ data-price
        const unitPrice = parseFloat($('#originPrice_' + productId).data('price') || 0);

        // Tính thành tiền mới
        const newTotal = unitPrice * currentQuantity;

        // Cập nhật lại giá trị thành tiền và data-total
        const totalPriceElement = $('#totalPrice_' + productId);
        totalPriceElement.text(formatCurrency(newTotal));
        totalPriceElement.attr('data-total', newTotal); // Đảm bảo cập nhật thuộc tính data-total

        // Gửi yêu cầu AJAX để lưu thay đổi vào cơ sở dữ liệu
        $.ajax({
            url: '/TTAP/cart/updateProductQuantity',
            type: 'POST',
            data: {
                productId: productId,
                newQuantity: currentQuantity
            },
            success: function (response) {
                console.log('Cập nhật số lượng thành công:', response);
                // Gọi lại hàm calculateTotal() để tính tổng sau khi cập nhật thành công
                calculateTotal();
            },
            error: function (xhr, status, error) {
                const errorMessage = xhr.responseJSON ? xhr.responseJSON.error : 'Có lỗi xảy ra';
                alert(errorMessage);
            }
        });
    }

    function submitCheckout() {
        const checkboxes = document.querySelectorAll('.product-checkbox:checked');
        const selectedProductIds = [];
        checkboxes.forEach(checkbox => {
            selectedProductIds.push(checkbox.value);
        });

        const form = document.querySelector('#checkoutForm');
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'selectedProductIds';
        input.value = selectedProductIds.join(',');
        form.appendChild(input);

        form.submit();  // Gửi form
    }

    // Lắng nghe sự kiện thay đổi checkbox
    document.querySelectorAll('.product-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', calculateTotal);
    });

    function formatCurrency(value) {
        const formatter = new Intl.NumberFormat('vi-VN', {
            style: 'decimal',
            minimumFractionDigits: 0,  // Đảm bảo luôn có ít nhất 3 chữ số thập phân
            maximumFractionDigits: 0   // Giới hạn tối đa 3 chữ số thập phân
        });

        let formattedValue = formatter.format(value);
        formattedValue = formattedValue.replace(/\./g, ',');  // Thay dấu "." thành dấu ","
        return formattedValue + " đ";  // Thêm "đ" vào cuối
    }
    function formatCurrencyVc(value) {
        const formatter = new Intl.NumberFormat('vi-VN', {
            style: 'decimal',
            minimumFractionDigits: 3,  // Đảm bảo luôn có ít nhất 3 chữ số thập phân
            maximumFractionDigits: 3   // Giới hạn tối đa 3 chữ số thập phân
        });

        let formattedValue = formatter.format(value);
        formattedValue = formattedValue.replace(/\./g, ',');  // Thay dấu "." thành dấu ","
        return formattedValue + " đ";  // Thêm "đ" vào cuối
    }
</script>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script th:src="@{/js/banhang.js}"></script>
<script src="/js/toastMessage.js"></script>
<script th:inline="javascript">
    /*<![CDATA[*/
    var removemessage = [[${removemessage}]];
    console.log(removemessage);  // Debugging line to ensure the attribute is set
    if (removemessage) {
        toastSuccess('Thành Công!', 'Sản phẩm đã được xóa khỏi giỏ hàng!');
    }
    /*]]>*/
</script>

<script th:inline="javascript">
    /*<![CDATA[*/
    var message = [[${message}]];
    console.log(message);  // Debugging line to ensure the attribute is set
    if (message) {
        toastSuccess('Thành Công!', 'Đơn hàng đã đặt thành công');
    }
    /*]]>*/
</script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const showModal = [[${failAddress}]]; // Thymeleaf expression
        if (showModal) {
            const modal = new bootstrap.Modal(document.getElementById('createAddressModal'));
            modal.show();
        }
    });
</script>

<script th:inline="javascript">
    /*<![CDATA[*/
    var failAddress = [[${failAddress}]];
    console.log(failAddress);  // Debugging line to ensure the attribute is set
    if (failAddress) {
        toastError('Thất bại!', 'Vui lòng điền đủ thông tin');
    }
    /*]]>*/
</script>

<script th:inline="javascript">
    /*<![CDATA[*/
    /* Check if the deleteSuccess attribute is present in the model */
    var addressNullError = [[${addressNullError}]];
    if (addressNullError) {
        toastError('Lỗi !', 'Địa chỉ của bạn không hợp lệ!');
    }
    /*]]>*/
</script>

<script th:inline="javascript">
    /*<![CDATA[*/
    /* Check if the deleteSuccess attribute is present in the model */
    var successDcMessage = [[${successDcMessage}]];
    if (successDcMessage) {
        toastSuccess('Thành công', 'Địa chỉ của bạn đã được chọn');
    }
    /*]]>*/
</script>
<script th:inline="javascript">
    /*<![CDATA[*/
    /* Check if the deleteSuccess attribute is present in the model */
    var successAddress= [[${successAddress}]];
    if (successAddress) {
        toastSuccess('Thành công', 'Địa chỉ của bạn đã được thêm ');
    }
    /*]]>*/
</script>
<script th:inline="javascript">
    /*<![CDATA[*/
    var errorMessage = [[${error}]];
    if (errorMessage) {
        toastError('Lỗi', errorMessage);
    }
    /*]]>*/
</script>
<script th:inline="javascript">
    /*<![CDATA[*/
    var successRemoveaddress= [[${successRemoveaddress}]];
    if (successRemoveaddress) {
        toastSuccess('Thành công', successRemoveaddress);
    }
    /*]]>*/
</script>
<script th:inline="javascript">
    /*<![CDATA[*/
    var success= [[${success}]];
    if (success) {
        toastSuccess('Thành công', success);
    }
    /*]]>*/
</script>
<footer th:replace="~{/fragment/footer-customer :: footer-customer}" class="text-center">
    <p>&copy; 2024 TTAP T-SHIRT. All rights reserved.</p>
</footer>
</body>
<script src="https://esgoo.net/scripts/jquery.js"></script>
<style type="text/css">
    .css_select_div{ text-align: center;}
    .css_select{ display: inline-table; width: 25%; padding: 5px; margin: 5px 2%; border: solid 1px #686868; border-radius: 5px;}
</style>
<script>
    $(document).ready(function() {
        // Lấy tỉnh thành từ GHN
        $.ajax({
            url: 'https://online-gateway.ghn.vn/shiip/public-api/master-data/province',
            type: 'GET',
            headers: {
                'Token': '25145a88-c2a2-11ef-b247-3a89ee222ada' // Sử dụng token của bạn ở đây
            },
            success: function(data_tinh) {
                if(data_tinh.code == 200) {
                    $.each(data_tinh.data, function (key_tinh, val_tinh) {
                        $("#tinh").append('<option value="'+val_tinh.ProvinceName+'" data-id="' + val_tinh.ProvinceID + '">'+val_tinh.ProvinceName+'</option>');
                    });
                    $("#tinh").change(function(e){
                        var idtinh = $("#tinh option:selected").data('id');
                        // Lấy quận huyện từ GHN
                        $.ajax({
                            url: 'https://online-gateway.ghn.vn/shiip/public-api/master-data/district',
                            type: 'GET',
                            headers: {
                                'Token': '25145a88-c2a2-11ef-b247-3a89ee222ada', // Sử dụng token của bạn ở đây
                            },
                            data: {
                                'province_id': idtinh
                            },
                            success: function(data_quan) {
                                if(data_quan.code == 200) {
                                    $("#quan").html('<option value="0">Quận Huyện</option>');
                                    $("#phuong").html('<option value="0">Phường Xã</option>');
                                    $.each(data_quan.data, function (key_quan, val_quan) {
                                        $("#quan").append('<option value="'+val_quan.DistrictName+'" data-id="' + val_quan.DistrictID + '">'+val_quan.DistrictName+'</option>');
                                    });
                                    // Lấy phường xã từ GHN
                                    $("#quan").change(function(e){
                                        var idquan = $("#quan option:selected").data('id');
                                        $.ajax({
                                            url: 'https://online-gateway.ghn.vn/shiip/public-api/master-data/ward',
                                            type: 'GET',
                                            headers: {
                                                'Token': '25145a88-c2a2-11ef-b247-3a89ee222ada', // Sử dụng token của bạn ở đây
                                            },
                                            data: {
                                                'district_id': idquan
                                            },
                                            success: function(data_phuong) {
                                                if(data_phuong.code == 200) {
                                                    $("#phuong").html('<option value="0">Phường Xã</option>');
                                                    $.each(data_phuong.data, function (key_phuong, val_phuong) {
                                                        $("#phuong").append('<option value="'+val_phuong.WardName+'" data-id="' + val_phuong.WardID + '">'+val_phuong.WardName+'</option>');
                                                    });
                                                }
                                            }
                                        });
                                    });
                                }
                            }
                        });
                    });
                }
            }
        });
    });
</script>
<script src="/js/jquery-3.3.1.min.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/jquery.nice-select.min.js"></script>
<script src="/js/jquery-ui.min.js"></script>
<script src="/js/jquery.slicknav.js"></script>
<script src="/js/mixitup.min.js"></script>
<script src="/js/owl.carousel.min.js"></script>
<script src="/js/main.js"></script>
</html>
